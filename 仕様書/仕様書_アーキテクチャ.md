md
# 仕様書 1/4：概要・アーキテクチャ編（MVP）

## 1. コンセプト
- ユーザーの寄り道を許容しつつ、予定が物理的に破綻する直前/直後だけ介入する「優秀な部下」型エージェント。
- 既存ナビのように「予定通り」を強制せず、**破綻が近い**ときだけ知らせ、破綻したら選択肢を提示してユーザー承認で工程を更新する。

---

## 2. MVPの目的
- 予定リストを保存し、当日の現在地から「破綻リスク」を判定して `ok/warn/broken` を返す。
- `broken` 時に **3択**（GO_NEXT / DETOUR(候補3件) / SKIP）を提示し、ユーザー選択を反映した更新済みPlanを返す。

---

## 3. スコープ（MVPでやること）
### 3.1 入力時（予定作成時）
- ユーザーが予定（場所名、到着時刻、滞在時間）を入力。
- サーバがPlaces等で予定を拡張し、Firestoreに保存：
  - `placeId`
  - `lat/lng`
  - `closeTime`（取得できる場合）
  - `deadline`（逆算して保存）

### 3.2 当日運用
- 端末が15分おきに `/check` を呼び、サーバが最も危険な1件のみを判定。
- warn（締切接近）で通知（端末側で文言生成）。
- broken（締切超過）で options を返し、ユーザー選択を `/apply-option` で反映。

---

## 4. 非スコープ（MVPではやらない）
- 自由入力→再提案（broken後は3択のみ）
- ルーティング/ナビ機能（将来Google Mapsへ遷移はあり得る）
- DETOUR候補の成立保証（Routesで検証して除外）はしない
- closeTime未取得予定の推定（未取得は判定対象外）
- 監視対象の複数返却（最も危険な1件のみ）
- 監視の厳密なバックグラウンド保証（多少遅れてもOK）

---

## 5. 全体アーキテクチャ
### 5.1 コンポーネント
- Client：Flutter（iOS/Android）
- Backend：Cloud Run（HTTP API）
- Storage：Firestore（`users/{userId}` に plan と lastBroken を保持）
- 外部API：Google Places、Gemini（候補選定）、（将来）Routes/Distance Matrix

### 5.2 役割
#### Client（Flutter）
- 認証して `userId` を保持
- 予定入力UI
- 15分おきに位置情報を取得し `/check` を呼ぶ
- warn通知表示
- broken時の3択UI表示→選択→`/apply-option`
- `updatedPlan` を反映

#### Backend（Cloud Run）
- `userId` からFirestoreの plan を取得
- 判定ロジックで `ok/warn/broken` を返す（最も危険な1件）
- broken時 options を生成し `lastBroken` に保存
- applyで plan を更新し、更新済みplanを返す

#### Firestore
- `users/{userId}` に集約保存（MVPはユーザー=1plan）
  - `plan`
  - `lastBroken`（最新のみ上書き）
  - `updatedAt`

---

## 6. データフロー（シーケンス）
### 6.1 入力時
1. Client：予定入力
2. Backend：Places等で補完（placeId/latlng/closeTime/deadline）
3. Backend：Firestoreへ plan 保存
4. Client：保存済みplanの表示

### 6.2 当日（15分ごとチェック）
1. Client → Backend：`/check(userId, now, currentLatLng)`
2. Backend：Firestoreから plan 読み出し→判定
3. Backend → Client：
   - ok：何もしない
   - warn：minutesToDeadline を返す（端末が通知文生成）
   - broken：options（3択）を返す＋Firestoreへ lastBroken 保存

### 6.3 broken後（ユーザー承認）
1. Client：3択UIを表示（DETOURは候補3件）
2. Client → Backend：`/apply-option(userId, targetItemId, choice)`
3. Backend：plan更新→Firestore保存→updatedPlan返却
4. Client：updatedPlan反映→次の15分チェックへ

---

## 7. 判定の前提（MVPルール）
### 7.1 監視対象の範囲
- plan.items の **先頭(i=0)と末尾(i=n-1)は監視対象外**
- 監視対象：`1 <= i <= n-2`
- `n < 3` のとき監視対象なし→常にok

### 7.2 「動いていない」判定
- `prev = items[i-1]` と現在地の距離が **400m以内**のときのみ warn/broken を返す  
  （400mを超える場合は通知せずok扱い）

### 7.3 提案（broken options）
- GO_NEXT / SKIP は固定
- DETOUR は「候補3件」を返す
  - サーバが検索範囲を絞ってPlaces候補集合を作る
  - Geminiが候補集合から3件選び、理由・startTime・stayMinutes等を付与
  - MVPでは成立保証（次予定に間に合う検証）は行わない

---
