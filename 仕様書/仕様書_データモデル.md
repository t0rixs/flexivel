# 仕様書 2/4：データモデル・Firestore設計編（MVP）

## 1. 共通ルール
- 時刻は ISO 8601 文字列
  - 例：`2026-02-14T12:22:00+09:00`
- `closeTime` が無い予定は判定対象外（監視・破綻判定しない）
- `deadline` は入力時点で算出して保存（当日のcheckでは基本的にそれを参照）
- plan.items は `startTime` 昇順が前提（サーバ側でソートしてよい）

---

## 2. Firestore 設計（MVP）
### 2.1 コレクション/ドキュメント
- Collection: `users`
- Document: `users/{userId}`

### 2.2 users/{userId} の型
```ts
type UserDoc = {
  plan: Plan;
  lastBroken?: LastBroken;  // 最新のみ上書き
  updatedAt: string;        // ISO
};




---

## 3. Plan（端末表示・サーバ判定の中心データ）

### 3.1 Plants
type Plan = {
  planId: string;       // UUID想定
  createdAt: string;    // ISO
  items: PlanItem[];    // startTime昇順
};




### 3.2 PlanItemts
type PlanItem = {
  id: string;           // UUID想定（placeIdで代用しない）
  name: string;         // 表示名（ユーザー入力）

  placeId: string;      // Google Places place_id
  lat: number;
  lng: number;

  startTime: string;    // 到着予定時刻（ISO）
  stayMinutes: number;  // ユーザー手入力

  closeTime?: string;   // ISO（取れない場合は未設定→判定対象外）
  deadline?: string;    // ISO（入力時に逆算して保存）
};




#### 補足
- MVPでは PlanItem に address は必須にしない（必要なら後で追加可能）
- ただし DETOUR候補（後述）には address を含める

---

## 4. lastBroken（broken時の最新状態）

### 4.1 LastBrokents
type LastBroken = {
  createdAt: string;        // ISO（broken判定した時刻）
  targetItemId: string;     // broken対象の PlanItem.id
  options: BrokenOption[];  // GO_NEXT / DETOUR / SKIP
};




---

## 5. BrokenOption（broken時の3択）

### 5.1 DetourCandidate（DETOUR候補1件）
※ユーザーが「どの本屋か分からない」問題を避けるため、座標と住所を必須にする。

ts
type DetourCandidate = {
  placeId: string;
  name: string;

  lat: number;
  lng: number;
  address: string;

  reason: string;

  startTime: string;     // ISO（MVPはAI提案値を信じる）
  stayMinutes: number;   // AI提案値
};




### 5.2 BrokenOptionts
type BrokenOption =
  | {
      kind: "GO_NEXT";
      reason: string;
    }
  | {
      kind: "DETOUR";
      reason: string;
      candidates: DetourCandidate[]; // 3件
    }
  | {
      kind: "SKIP";
      reason: string;
    };




---

## 6. JSON例（Firestore users/{userId}）
```json
{
  "plan": {
    "planId": "plan_123",
    "createdAt": "2026-02-14T10:00:00+09:00",
    "items": [
      {
        "id": "item_0",
        "name": "出発地点",
        "placeId": "ChIJ_start",
        "lat": 35.681236,
        "lng": 139.767125,
        "startTime": "2026-02-14T10:00:00+09:00",
        "stayMinutes": 0,
        "closeTime": "2026-02-14T23:59:00+09:00",
        "deadline": "2026-02-14T09:50:00+09:00"
      },
      {
        "id": "item_1",
        "name": "美術館B",
        "placeId": "ChIJ_museum",
        "lat": 35.689487,
        "lng": 139.691711,
        "startTime": "2026-02-14T13:00:00+09:00",
        "stayMinutes": 90,
        "closeTime": "2026-02-14T17:00:00+09:00",
        "deadline": "2026-02-14T12:05:00+09:00"
      },
      {
        "id": "item_2",
        "name": "宿",
        "placeId": "ChIJ_hotel",
        "lat": 35.700000,
        "lng": 139.700000,
        "startTime": "2026-02-14T20:00:00+09:00",
        "stayMinutes": 0,
        "closeTime": "2026-02-14T23:59:00+09:00",
        "deadline": "2026-02-14T19:30:00+09:00"
      }
    ]
  },
  "lastBroken": {
    "createdAt": "2026-02-14T12:06:00+09:00",
    "targetItemId": "item_1",
    "options": [
      {
        "kind": "GO_NEXT",
        "reason": "次の予定を優先して、すぐ移動します。"
      },
      {
        "kind": "DETOUR",
        "reason": "次の予定に間に合う範囲で寄り道候補を提案します。",
        "candidates": [
          {
            "placeId": "ChIJdetour111",
            "name": "近くの本屋A",
            "lat": 35.6901,
            "lng": 139.6920,
            "address": "東京都新宿区…",
            "reason": "移動が短く、短時間の滞在に向いています。",
            "startTime": "2026-02-14T12:20:00+09:00",
            "stayMinutes": 15
          },
          {
            "placeId": "ChIJdetour222",
            "name": "カフェC",
            "lat": 35.6905,
            "lng": 139.6932,
            "address": "東京都新宿区…",
            "reason": "次予定への移動がしやすい位置です。",[10:25]"startTime": "2026-02-14T12:18:00+09:00",
            "stayMinutes": 20
          },
          {
            "placeId": "ChIJdetour333",
            "name": "休憩スポットD",
            "lat": 35.6899,
            "lng": 139.6922,
            "address": "東京都新宿区…",
            "reason": "短時間で立ち寄れて気分転換できます。",
            "startTime": "2026-02-14T12:22:00+09:00",
            "stayMinutes": 15
          }
        ]
      },
      {
        "kind": "SKIP",
        "reason": "この予定は諦めて、次の予定に備えます。"
      }
    ]
  },
  "updatedAt": "2026-02-14T12:06:10+09:00"
}
---