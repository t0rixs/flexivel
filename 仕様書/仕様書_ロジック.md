# 仕様書 3/4：判定ロジック（check）・提案生成（broken）編（MVP）

## 1. 用語
- `n`: plan.items.length
- `i`: plan.itemsのインデックス
- `prev`: `items[i-1]`（直前地点）
- `target`: 最も締切が近い監視対象1件
- `minutesToDeadline`: `floor((deadline - now)/60秒)`（切り捨て）

---

## 2. 監視対象の範囲（重要）
- 監視対象：**`1 <= i <= n-2`**
  - i=0（先頭）は除外
  - i=n-1（末尾）は除外（帰路/宿など想定）
- `n < 3` の場合：監視対象なし → 常に `ok`

---

## 3. 判定に必要なフィールド
監視対象予定 `items[i]` が判定対象になる条件：
- `items[i].deadline` が存在
- `items[i].closeTime` が存在（無い場合は判定対象外）

---

## 4. 「動いていない」判定
- `prev = items[i-1]`
- `distance(currentLatLng, prev.latlng) <= 400m` の場合のみ warn/broken を返す
- 400m超なら通知せず `ok` 扱い

---

## 5. /check 判定アルゴリズム（擬似コード）

### 5.1 監視対象の有無
```pseudo
n = items.length
if n < 3:
  return ok




### 5.2 candidates生成（i=1..n-2）pseudo
candidates = []
for i in 1..n-2:
  item = items[i]
  if item.deadline is null: continue
  if item.closeTime is null: continue

  m = floor((deadline - now)/60sec)

  prev = items[i-1]
  d = distance(current, prev)

  candidates.push({ itemId: item.id, minutesToDeadline: m, withinPrev400m: (d<=400), index: i })




### 5.3 target選定（最も締切が近い1件）pseudo
if candidates empty:
  return ok

target = minBy(candidates, minutesToDeadline)




### 5.4 ok/warn/brokenの判定pseudo
if target.withinPrev400m == false:
  return ok

m = target.minutesToDeadline

if m <= 0:
  return broken(target.itemId, options...)

if 1 <= m <= 15:
  return warn(target.itemId, m)

return ok




---

## 6. warn の仕様
- 返す情報：
  - status="warn"
  - targetItemId
  - minutesToDeadline（切り捨て整数）
- 通知文は端末側で生成：
  - 「{minutes}分までに出発しないと、次の予定に間に合わない可能性があります。」

---

## 7. broken の仕様
- 返す情報：
  - status="broken"
  - targetItemId
  - options（GO_NEXT / DETOUR / SKIP）
- 併せて Firestore に lastBroken を保存（最新のみ上書き）

---

## 8. broken時 options 生成（MVP）

### 8.1 GO_NEXT / SKIP
- GO_NEXT: 固定文（MVP）
- SKIP: 固定文（MVP）

### 8.2 DETOUR（寄り道候補3件）
方針：
- **成立保証なし**（Routesで「次予定に間に合う」検証はMVPでは行わない）
- サーバが検索範囲を絞り、候補集合を作る
- Geminiが候補集合から3件を選び、理由・startTime・stayMinutes等を付与
- DETOUR optionとして candidates[3] を返す

#### 手順
1. サーバ：検索範囲決定（例：現在地周辺）
2. サーバ：Places APIで候補集合 candidatePool を取得
   - placeId, name, lat, lng, address を含む
3. サーバ → Gemini：候補集合＋コンテキストを渡す
   - now
   - next予定の startTime（参考情報として）
   - 「候補は3件」「理由必須」「startTime/stayMinutesも提案」など制約
4. Gemini → サーバ：DetourCandidate[3] を返す
5. サーバ：BrokenOption(DETOUR)を組み立てて返す

#### DETOUR候補（DetourCandidate）の必須項目
- placeId, name
- lat, lng, address
- reason
- startTime（ISO）
- stayMinutes（number）

---

## 9. lastBroken 保存ルール
- broken判定時に users/{userId}.lastBroken を上書き保存
- 保存内容：
  - createdAt（now）
  - targetItemId
  - options（GO_NEXT/DETOUR/SKIP）

---